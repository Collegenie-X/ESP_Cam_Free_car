# í”„ë¡ íŠ¸ì—”ë“œ ë¦¬íŒ©í† ë§ ë¬¸ì„œ

## ğŸ¯ ë¦¬íŒ©í† ë§ ëª©í‘œ

ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼(`app.py`)ë¡œ êµ¬ì„±ëœ Flask ì• í”Œë¦¬ì¼€ì´ì…˜ì„ **ëª¨ë“ˆí™”**í•˜ì—¬ ìœ ì§€ë³´ìˆ˜ì„±ê³¼ í™•ì¥ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

---

## ğŸ“ ë³€ê²½ëœ í´ë” êµ¬ì¡°

### Before (ê¸°ì¡´)
```
frontend/
â”œâ”€â”€ app.py                    # ëª¨ë“  ë¡œì§ì´ í•˜ë‚˜ì˜ íŒŒì¼ì— ì§‘ì¤‘
â”œâ”€â”€ config.py
â””â”€â”€ templates/
    â””â”€â”€ index.html
```

### After (ê°œì„ )
```
frontend/
â”œâ”€â”€ app.py                    # ë©”ì¸ ì§„ì…ì  (ê°„ì†Œí™”ë¨)
â”œâ”€â”€ config.py                 # ì„¤ì • íŒŒì¼ (ë³€ê²½ ì—†ìŒ)
â”‚
â”œâ”€â”€ core/                     # ğŸ”§ í•µì‹¬ ì„¤ì •
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ app_factory.py        # Flask ì•± íŒ©í† ë¦¬ (ì•± ìƒì„± ë° ì´ˆê¸°í™”)
â”‚   â””â”€â”€ logger_config.py      # ë¡œê±° ì„¤ì •
â”‚
â”œâ”€â”€ services/                 # ğŸ’¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ esp32_communication_service.py  # ESP32 í†µì‹  ì„œë¹„ìŠ¤
â”‚
â”œâ”€â”€ routes/                   # ğŸ›£ï¸ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main_routes.py        # ë©”ì¸ í˜ì´ì§€ ë¼ìš°íŠ¸
â”‚   â”œâ”€â”€ api_routes.py         # API ì—”ë“œí¬ì¸íŠ¸ ë¼ìš°íŠ¸
â”‚   â””â”€â”€ camera_routes.py      # ì¹´ë©”ë¼ ê´€ë ¨ ë¼ìš°íŠ¸
â”‚
â”œâ”€â”€ utils/                    # ğŸ”¨ ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ server_port_selector.py
â”‚
â””â”€â”€ templates/
    â””â”€â”€ index.html
```

---

## ğŸ“¦ ëª¨ë“ˆ ì„¤ëª…

### 1. `core/` - í•µì‹¬ ì„¤ì •

#### `app_factory.py` - Flask ì•± íŒ©í† ë¦¬
- **ì—­í• **: Flask ì•± ìƒì„± ë° ì´ˆê¸°í™”
- **ì£¼ìš” í•¨ìˆ˜**:
  - `create_app()`: ì•± ìƒì„± (íŒ©í† ë¦¬ íŒ¨í„´)
  - `register_blueprints()`: ë¸”ë£¨í”„ë¦°íŠ¸ ë“±ë¡
  - `register_error_handlers()`: ì—ëŸ¬ í•¸ë“¤ëŸ¬ ë“±ë¡

#### `logger_config.py` - ë¡œê±° ì„¤ì •
- **ì—­í• **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì˜ ë¡œê¹… ì„¤ì •
- **ì£¼ìš” í•¨ìˆ˜**:
  - `setup_logger()`: ë¡œê±° ì´ˆê¸°í™”

---

### 2. `services/` - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

#### `esp32_communication_service.py` - ESP32 í†µì‹  ì„œë¹„ìŠ¤
- **ì—­í• **: ESP32-CAMê³¼ì˜ HTTP í†µì‹  ë‹´ë‹¹
- **í´ë˜ìŠ¤**: `ESP32CommunicationService`
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `get_status()`: ESP32 ìƒíƒœ ì¡°íšŒ
  - `send_command()`: ESP32ì— ëª…ë ¹ ì „ì†¡
  - `get_stream_url()`: ìŠ¤íŠ¸ë¦¼ URL ë°˜í™˜
  - `get_capture_url()`: ìº¡ì²˜ URL ë°˜í™˜

---

### 3. `routes/` - ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬

#### `main_routes.py` - ë©”ì¸ í˜ì´ì§€ ë¼ìš°íŠ¸
- **ì—­í• **: ì›¹ í˜ì´ì§€ ë Œë”ë§
- **ë¸”ë£¨í”„ë¦°íŠ¸**: `main_bp`
- **ì—”ë“œí¬ì¸íŠ¸**:
  - `GET /`: ë©”ì¸ ëŒ€ì‹œë³´ë“œ
  - `GET /settings`: ì„¤ì • í˜ì´ì§€

#### `api_routes.py` - API ì—”ë“œí¬ì¸íŠ¸ ë¼ìš°íŠ¸
- **ì—­í• **: ESP32 ì œì–´ API
- **ë¸”ë£¨í”„ë¦°íŠ¸**: `api_bp` (prefix: `/api`)
- **ì—”ë“œí¬ì¸íŠ¸**:
  - `GET /api/status`: ìƒíƒœ ì¡°íšŒ
  - `GET /api/control/<command>`: ëª¨í„° ì œì–´
  - `GET /api/led/<state>`: LED ì œì–´
  - `GET /api/speed/<operation>`: ì†ë„ ì œì–´
  - `GET /api/camera/<param>`: ì¹´ë©”ë¼ ì„¤ì •

#### `camera_routes.py` - ì¹´ë©”ë¼ ê´€ë ¨ ë¼ìš°íŠ¸
- **ì—­í• **: ì¹´ë©”ë¼ ì´ë¯¸ì§€/ìŠ¤íŠ¸ë¦¼ ì œê³µ
- **ë¸”ë£¨í”„ë¦°íŠ¸**: `camera_bp`
- **ì—”ë“œí¬ì¸íŠ¸**:
  - `GET /capture`: ë‹¨ì¼ ì´ë¯¸ì§€ ìº¡ì²˜
  - `GET /stream`: ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°

---

## ğŸ”„ ì£¼ìš” ë³€ê²½ ì‚¬í•­

### 1. íŒ©í† ë¦¬ íŒ¨í„´ ë„ì…
```python
# Before
app = Flask(__name__)

# After
from core.app_factory import create_app
app = create_app()
```

### 2. ë¸”ë£¨í”„ë¦°íŠ¸ë¡œ ë¼ìš°íŠ¸ ê·¸ë£¹í™”
```python
# Before
@app.route("/")
def index():
    ...

# After
from flask import Blueprint
main_bp = Blueprint('main', __name__)

@main_bp.route("/")
def index():
    ...
```

### 3. ì„œë¹„ìŠ¤ ê³„ì¸µ ë¶„ë¦¬
```python
# Before
def send_esp32_command(endpoint, params=None):
    try:
        url = f"{ESP32_BASE_URL}{endpoint}"
        response = requests.get(url, params=params, timeout=REQUEST_TIMEOUT)
        ...

# After
class ESP32CommunicationService:
    def send_command(self, endpoint, params=None):
        ...
```

---

## âœ… ì¥ì 

### 1. **ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬ (Separation of Concerns)**
- UI ë¡œì§ (`routes/`)ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (`services/`) ë¶„ë¦¬
- ê° ëª¨ë“ˆì´ ëª…í™•í•œ ì±…ì„ì„ ê°€ì§

### 2. **ì¬ì‚¬ìš©ì„± í–¥ìƒ**
- `ESP32CommunicationService`ëŠ” ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥
- ë…ë¦½ì ì¸ ëª¨ë“ˆë¡œ í…ŒìŠ¤íŠ¸ ìš©ì´

### 3. **í™•ì¥ì„± ì¦ëŒ€**
- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ í•´ë‹¹ í´ë”ì— íŒŒì¼ë§Œ ì¶”ê°€
- ì˜ˆ: ìƒˆë¡œìš´ API â†’ `routes/` í´ë”ì— ë¸”ë£¨í”„ë¦°íŠ¸ ì¶”ê°€

### 4. **ìœ ì§€ë³´ìˆ˜ í¸ë¦¬**
- ê¸°ëŠ¥ë³„ë¡œ íŒŒì¼ì´ ë¶„ë¦¬ë˜ì–´ ì½”ë“œ ì°¾ê¸° ì‰¬ì›€
- ë²„ê·¸ ìˆ˜ì • ì‹œ ì˜í–¥ ë²”ìœ„ê°€ ëª…í™•í•¨

### 5. **ê°€ë…ì„± í–¥ìƒ**
- `app.py`ê°€ 237ì¤„ â†’ 38ì¤„ë¡œ ê°ì†Œ
- íŒŒì¼ëª…ë§Œìœ¼ë¡œ ê¸°ëŠ¥ íŒŒì•… ê°€ëŠ¥

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ê¸°ì¡´ê³¼ ë™ì¼
```bash
# ê°€ìƒí™˜ê²½ í™œì„±í™”
source venv/bin/activate  # Linux/Mac
# ë˜ëŠ”
.\venv\Scripts\activate   # Windows

# ì‹¤í–‰
python app.py
```

### ë³€ê²½ ì‚¬í•­ ì—†ìŒ
- ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” ë™ì¼í•˜ê²Œ ì‘ë™
- ë‚´ë¶€ êµ¬ì¡°ë§Œ ê°œì„ ë¨

---

## ğŸ“ íŒŒì¼ëª… ê·œì¹™

### íŒŒì¼ëª… íŒ¨í„´
- **ì„œë¹„ìŠ¤**: `{ê¸°ëŠ¥}_service.py`
  - ì˜ˆ: `esp32_communication_service.py`
- **ë¼ìš°íŠ¸**: `{ê¸°ëŠ¥}_routes.py`
  - ì˜ˆ: `main_routes.py`, `api_routes.py`
- **ì„¤ì •**: `{ê¸°ëŠ¥}_config.py`
  - ì˜ˆ: `logger_config.py`

### í•¨ìˆ˜ëª…/í´ë˜ìŠ¤ëª… ê·œì¹™
- **í´ë˜ìŠ¤ëª…**: PascalCase (ì˜ˆ: `ESP32CommunicationService`)
- **í•¨ìˆ˜ëª…**: snake_case (ì˜ˆ: `get_status`, `send_command`)
- **ìƒìˆ˜ëª…**: UPPER_SNAKE_CASE (ì˜ˆ: `DEFAULT_ESP32_IP`)

---

## ğŸ” ë””ë²„ê¹… ê°€ì´ë“œ

### ë¡œê·¸ í™•ì¸
```python
# ë¡œê±°ëŠ” ëª¨ë“  ëª¨ë“ˆì—ì„œ ì‚¬ìš© ê°€ëŠ¥
import logging
logger = logging.getLogger(__name__)

logger.info("ì •ë³´ ë¡œê·¸")
logger.error("ì—ëŸ¬ ë¡œê·¸")
```

### íŠ¹ì • ê¸°ëŠ¥ ë¬¸ì œ ë°œìƒ ì‹œ

| ë¬¸ì œ ì˜ì—­ | í™•ì¸í•  íŒŒì¼ |
|----------|-----------|
| ëª¨í„° ì œì–´ ì•ˆë¨ | `routes/api_routes.py` â†’ `control_motor()` |
| ì¹´ë©”ë¼ ì´ë¯¸ì§€ ì•ˆë‚˜ì˜´ | `routes/camera_routes.py` â†’ `capture_image()` |
| ESP32 í†µì‹  ì‹¤íŒ¨ | `services/esp32_communication_service.py` |
| í˜ì´ì§€ ë Œë”ë§ ì˜¤ë¥˜ | `routes/main_routes.py` |

---

## ğŸ“š ì¶”ê°€ ì°¸ê³ 

### Flask ë¸”ë£¨í”„ë¦°íŠ¸
- ê³µì‹ ë¬¸ì„œ: https://flask.palletsprojects.com/en/latest/blueprints/
- ë¼ìš°íŠ¸ë¥¼ ëª¨ë“ˆí™”í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” Flaskì˜ ê¸°ëŠ¥

### íŒ©í† ë¦¬ íŒ¨í„´
- ì•± ìƒì„± ë¡œì§ì„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
- í…ŒìŠ¤íŠ¸, ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ ìœ ë¦¬

---

## ğŸ“ í•™ìŠµ í¬ì¸íŠ¸

1. **ëª¨ë“ˆí™”ì˜ ì¤‘ìš”ì„±**: í° íŒŒì¼ì„ ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
2. **ë””ìì¸ íŒ¨í„´ í™œìš©**: íŒ©í† ë¦¬ íŒ¨í„´, ì„œë¹„ìŠ¤ íŒ¨í„´
3. **í´ë¦° ì½”ë“œ**: Early Return, ëª…í™•í•œ ë„¤ì´ë°
4. **í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°**: ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ê°€ ì‰¬ìš´ êµ¬ì¡°

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ë¸”ë£¨í”„ë¦°íŠ¸ ì‚¬ìš© ì‹œ
- `current_app`ìœ¼ë¡œ ì•± ì„¤ì •ì— ì ‘ê·¼
- ìˆœí™˜ ì°¸ì¡°(Circular Import) ì£¼ì˜

### ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤
- `app.config`ì— ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
- ë¼ìš°íŠ¸ì—ì„œ `current_app.config.get()`ìœ¼ë¡œ ì ‘ê·¼

---

**ì‘ì„±ì¼**: 2025-10-22  
**ë²„ì „**: 2.0.0  
**ì‘ì„±ì**: ESP32-CAM Free Car Project Team

