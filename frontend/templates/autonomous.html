<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자율주행 모니터링 - ESP32-CAM 자율주행차</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        /* 스트림 컨테이너 */
        .stream-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
        }

        #videoStream {
            width: 100%;
            border-radius: 10px;
            display: block;
        }

        .stream-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            font-size: 1.2rem;
        }

        .stream-overlay.show {
            display: flex;
        }

        #retryButton {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-top: 15px;
        }

        #retryButton:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        /* 제어 패널 */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn {
            padding: 15px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 9, 121, 0.4);
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 상태 표시 */
        .status-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .status-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .status-running {
            color: #38ef7d;
        }

        .status-stopped {
            color: #ff6a00;
        }

        /* 히스토그램 */
        .histogram {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .histogram-bar {
            flex: 1;
            margin: 0 10px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            transition: height 0.3s;
            position: relative;
            min-height: 5px;
        }

        .histogram-bar.left {
            background: linear-gradient(to top, #ee0979, #ff6a00);
        }

        .histogram-bar.center {
            background: linear-gradient(to top, #11998e, #38ef7d);
        }

        .histogram-bar.right {
            background: linear-gradient(to top, #667eea, #764ba2);
        }

        .histogram-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }

        .histogram-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }

        /* 로그 */
        .log-box {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff6a00;
        }

        .log-entry.success {
            color: #38ef7d;
        }

        /* 통계 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
        }

        /* 반응형 */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .status-box {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🚗 자율주행 모니터링</h1>
            <p>ESP32-CAM 기반 차선 추적 시스템 (prod.md 구현)</p>
        </div>

        <!-- 대시보드 -->
        <div class="dashboard">
            <!-- 왼쪽: 비디오 스트림 -->
            <div class="card">
                <div class="card-title">📹 실시간 스트림</div>
                <div class="stream-container">
                    <img id="videoStream" src="" alt="비디오 스트림">
                    <div class="stream-overlay" id="streamOverlay">
                        <div>
                            <p id="streamStatus">카메라 연결 중...</p>
                            <button class="btn btn-secondary" onclick="retryStream()" style="margin-top: 15px; display: none;" id="retryButton">
                                🔄 재시도
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 히스토그램 -->
                <div style="margin-top: 20px;">
                    <strong>차선 픽셀 분포 (히스토그램)</strong>
                    <div class="histogram">
                        <div style="flex: 1; text-align: center;">
                            <div class="histogram-bar left" id="histLeft" style="height: 0%;">
                                <span class="histogram-value" id="histLeftValue">0</span>
                            </div>
                            <div class="histogram-label">왼쪽</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div class="histogram-bar center" id="histCenter" style="height: 0%;">
                                <span class="histogram-value" id="histCenterValue">0</span>
                            </div>
                            <div class="histogram-label">중앙</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div class="histogram-bar right" id="histRight" style="height: 0%;">
                                <span class="histogram-value" id="histRightValue">0</span>
                            </div>
                            <div class="histogram-label">오른쪽</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 제어 패널 -->
            <div class="card">
                <div class="card-title">🎮 제어</div>
                <div class="control-panel">
                    <button class="btn btn-start" id="btnStart" onclick="startAutonomous()">
                        ▶️ 자율주행 시작
                    </button>
                    <button class="btn btn-stop" id="btnStop" onclick="stopAutonomous()" disabled>
                        ⏹️ 자율주행 중지
                    </button>
                    <button class="btn btn-analyze" onclick="analyzeSingleFrame()">
                        🔍 단일 프레임 분석
                    </button>
                </div>

                <!-- 상태 표시 -->
                <div class="status-box">
                    <div class="status-item">
                        <div class="status-label">실행 상태</div>
                        <div class="status-value status-stopped" id="statusRunning">정지</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">현재 명령</div>
                        <div class="status-value" id="statusCommand">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">주행 상태</div>
                        <div class="status-value" id="statusState">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">신뢰도</div>
                        <div class="status-value" id="statusConfidence">-</div>
                    </div>
                </div>

                <!-- 통계 -->
                <div style="margin-top: 30px;">
                    <strong>통계</strong>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">처리 프레임</div>
                            <div class="stat-value" id="statFrames">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">명령 전송</div>
                            <div class="stat-value" id="statCommands">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">오류</div>
                            <div class="stat-value" id="statErrors">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">경과 시간</div>
                            <div class="stat-value" id="statTime">0s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">FPS</div>
                            <div class="stat-value" id="statFPS">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로그 -->
        <div class="card">
            <div class="card-title">📜 시스템 로그</div>
            <div class="log-box" id="logBox">
                <div class="log-entry">시스템 준비 완료...</div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        const ESP32_IP = "{{ esp32_ip }}";
        let statusInterval = null;
        let streamRetryCount = 0;
        const MAX_RETRY = 3;
        const RETRY_INTERVAL = 5000; // 5초

        // 스트림 상태 표시
        function showStreamStatus(message, showRetry = false) {
            const overlay = document.getElementById('streamOverlay');
            const status = document.getElementById('streamStatus');
            const retryBtn = document.getElementById('retryButton');
            
            status.textContent = message;
            retryBtn.style.display = showRetry ? 'block' : 'none';
            overlay.classList.add('show');
        }

        function hideStreamStatus() {
            const overlay = document.getElementById('streamOverlay');
            overlay.classList.remove('show');
        }

        // 카메라 연결 확인
        async function checkCamera() {
            try {
                const response = await fetch('/api/autonomous/check_camera');
                const data = await response.json();
                
                if (!data.success) {
                    showStreamStatus(`카메라 연결 실패: ${data.error}`, true);
                    addLog(`✗ 카메라 연결 실패: ${data.error}`, 'error');
                    return false;
                }
                addLog('✓ 카메라 연결 성공', 'success');
                return true;
            } catch (e) {
                showStreamStatus(`카메라 체크 오류: ${e.message}`, true);
                addLog(`✗ 카메라 체크 오류: ${e.message}`, 'error');
                return false;
            }
        }

        // 스트림 초기화
        async function initStream() {
            showStreamStatus('카메라 연결 확인 중...');
            addLog('카메라 연결 확인 중...', 'info');
            
            if (await checkCamera()) {
                const videoStream = document.getElementById('videoStream');
                videoStream.src = '/api/autonomous/stream';
                videoStream.onerror = handleStreamError;
                
                // 이미지 로드 성공 시
                videoStream.onload = () => {
                    hideStreamStatus();
                    addLog('✓ 스트림 연결 성공', 'success');
                };
                
                // 10초 후에도 이미지가 없으면 재시도
                setTimeout(() => {
                    if (!videoStream.naturalWidth) {
                        handleStreamError();
                    } else {
                        hideStreamStatus();
                        addLog('✓ 스트림 연결 성공', 'success');
                    }
                }, 10000);
            }
        }

        // 스트림 에러 처리
        function handleStreamError() {
            showStreamStatus('스트림 연결 실패', true);
            addLog('✗ 스트림 연결 실패', 'error');
        }

        // 스트림 재시도
        function retryStream() {
            if (streamRetryCount >= MAX_RETRY) {
                showStreamStatus('재시도 횟수 초과. 페이지를 새로고침하세요.', true);
                addLog('✗ 재시도 횟수 초과', 'error');
                return;
            }

            streamRetryCount++;
            showStreamStatus('스트림 재연결 중...');
            addLog('스트림 재연결 시도...', 'info');
            
            const videoStream = document.getElementById('videoStream');
            videoStream.src = '/api/autonomous/stream?' + new Date().getTime();
        }

        // 자율주행 시작
        async function startAutonomous() {
            try {
                addLog('자율주행 시작 요청...', 'info');
                
                const response = await fetch('/api/autonomous/start', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    addLog('✓ 자율주행 시작됨 - 명령이 ESP32로 전송됩니다', 'success');
                    document.getElementById('btnStart').disabled = true;
                    document.getElementById('btnStop').disabled = false;
                    
                    // 상태 폴링 시작
                    startStatusPolling();
                } else {
                    addLog('✗ 시작 실패: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('✗ 오류: ' + error.message, 'error');
            }
        }

        // 자율주행 중지
        async function stopAutonomous() {
            try {
                addLog('자율주행 중지 요청...', 'info');
                
                const response = await fetch('/api/autonomous/stop', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    addLog('✓ 자율주행 중지됨 - 명령 전송이 중지됩니다 (스트림은 계속 표시)', 'success');
                    document.getElementById('btnStart').disabled = false;
                    document.getElementById('btnStop').disabled = true;
                    
                    // 상태 폴링 중지
                    stopStatusPolling();
                    
                    // 통계 업데이트
                    if (data.stats) {
                        updateStats(data.stats);
                    }
                } else {
                    addLog('✗ 중지 실패: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('✗ 오류: ' + error.message, 'error');
            }
        }

        // 단일 프레임 분석
        async function analyzeSingleFrame() {
            try {
                addLog('단일 프레임 분석 중...', 'info');
                
                const response = await fetch('/api/autonomous/analyze', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    addLog(`✓ 분석 완료: ${data.command} (신뢰도: ${(data.confidence * 100).toFixed(1)}%)`, 'success');
                    
                    // 결과 표시
                    document.getElementById('statusCommand').textContent = data.command;
                    document.getElementById('statusState').textContent = data.state;
                    document.getElementById('statusConfidence').textContent = (data.confidence * 100).toFixed(1) + '%';
                    
                    // 히스토그램 업데이트
                    updateHistogram(data.histogram);
                    
                    // 이미지 표시
                    if (data.image_base64) {
                        document.getElementById('videoStream').src = 'data:image/jpeg;base64,' + data.image_base64;
                    }
                } else {
                    addLog('✗ 분석 실패: ' + data.error, 'error');
                }
            } catch (error) {
                addLog('✗ 오류: ' + error.message, 'error');
            }
        }

        // 상태 폴링 시작
        function startStatusPolling() {
            console.log('🔄 상태 폴링 시작');
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/autonomous/status');
                    const data = await response.json();

                    console.log('📊 상태 업데이트:', data);

                    if (data.success) {
                        // 상태 업데이트
                        document.getElementById('statusRunning').textContent = data.is_running ? '실행 중' : '정지';
                        document.getElementById('statusRunning').className = data.is_running ? 'status-value status-running' : 'status-value status-stopped';
                        
                        if (data.last_command) {
                            document.getElementById('statusCommand').textContent = data.last_command;
                            
                            // 명령에 따라 색상 변경
                            const commandEl = document.getElementById('statusCommand');
                            if (data.last_command === 'LEFT') {
                                commandEl.style.color = '#ff6a00';
                            } else if (data.last_command === 'RIGHT') {
                                commandEl.style.color = '#ff00ff';
                            } else if (data.last_command === 'CENTER') {
                                commandEl.style.color = '#38ef7d';
                            } else if (data.last_command === 'STOP') {
                                commandEl.style.color = '#ee0979';
                            }
                        }
                        
                        if (data.state) {
                            const stateText = {
                                'NORMAL_DRIVING': '일반 주행',
                                'CORNER_DETECTED': '코너 감지',
                                'TURNING': '회전 중'
                            }[data.state] || data.state;
                            document.getElementById('statusState').textContent = stateText;
                        }

                        // 통계 업데이트
                        if (data.stats) {
                            updateStats(data.stats);
                        }

                        // 명령 히스토리에서 최근 히스토그램 가져오기
                        if (data.command_history && data.command_history.length > 0) {
                            const latestCommand = data.command_history[data.command_history.length - 1];
                            if (latestCommand.histogram) {
                                updateHistogram(latestCommand.histogram);
                            }
                        }
                    }
                } catch (error) {
                    console.error('상태 조회 오류:', error);
                }
            }, 1000); // 1초마다
        }

        // 상태 폴링 중지
        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // 통계 업데이트
        function updateStats(stats) {
            document.getElementById('statFrames').textContent = stats.frames_processed || 0;
            document.getElementById('statCommands').textContent = stats.commands_sent || 0;
            document.getElementById('statErrors').textContent = stats.errors || 0;
            document.getElementById('statTime').textContent = stats.elapsed_time || '0s';
            document.getElementById('statFPS').textContent = stats.fps || '0';
        }

        // 히스토그램 업데이트
        function updateHistogram(histogram) {
            const maxValue = Math.max(histogram.left, histogram.center, histogram.right, 1);
            
            const leftPercent = (histogram.left / maxValue) * 100;
            const centerPercent = (histogram.center / maxValue) * 100;
            const rightPercent = (histogram.right / maxValue) * 100;

            document.getElementById('histLeft').style.height = leftPercent + '%';
            document.getElementById('histCenter').style.height = centerPercent + '%';
            document.getElementById('histRight').style.height = rightPercent + '%';

            document.getElementById('histLeftValue').textContent = histogram.left;
            document.getElementById('histCenterValue').textContent = histogram.center;
            document.getElementById('histRightValue').textContent = histogram.right;
        }

        // 로그 추가
        function addLog(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${timestamp}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;

            // 최대 100개 로그만 유지
            while (logBox.children.length > 100) {
                logBox.removeChild(logBox.firstChild);
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            addLog('자율주행 모니터링 시스템 준비 완료', 'success');
            addLog(`ESP32-CAM IP: ${ESP32_IP}`, 'info');
            initStream();
        });
    </script>
</body>
</html>