<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ììœ¨ì£¼í–‰ ëª¨ë‹ˆí„°ë§ - ESP32-CAM ììœ¨ì£¼í–‰ì°¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        /* ìŠ¤íŠ¸ë¦¼ ì»¨í…Œì´ë„ˆ */
        .stream-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
            margin-bottom: 20px;  /* ê²°ê³¼ íŒ¨ë„ê³¼ì˜ ê°„ê²© */
        }

        #videoStream {
            width: 100%;
            border-radius: 10px;
            display: block;
        }

        .stream-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            font-size: 1.2rem;
        }

        .stream-overlay.show {
            display: flex;
        }

        #retryButton {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-top: 15px;
        }

        #retryButton:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        /* ì œì–´ íŒ¨ë„ */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn {
            padding: 15px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 9, 121, 0.4);
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-analyze.analyzing {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            cursor: wait;
        }
        
        .analysis-timer {
            margin-top: 10px;
            text-align: center;
            color: #667eea;
            font-weight: bold;
            font-size: 0.9rem;
            animation: pulse 1s infinite;
        }
        
        .analysis-result {
            margin-top: 15px;
            padding: 10px;  /* íŒ¨ë”© ê°ì†Œ */
            background: rgba(0, 0, 0, 0.85);  /* ë°°ê²½ ë” ì–´ë‘¡ê²Œ */
            border-radius: 5px;  /* ë¼ìš´ë“œ ê°ì†Œ */
            border: 1px solid rgba(102, 126, 234, 0.4);
            position: absolute;
            bottom: 10px;  /* ìœ„ì¹˜ ì¡°ì • */
            left: 10px;
            right: 10px;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
            z-index: 10;
            font-family: 'Courier New', monospace;  /* ê³ ì •í­ í°íŠ¸ */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-label {
            color: #ffffff;
            font-size: 0.7rem;  /* í°íŠ¸ í¬ê¸° ê°ì†Œ */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-family: 'Courier New', monospace;  /* ê³ ì •í­ í°íŠ¸ */
            text-transform: uppercase;  /* ëŒ€ë¬¸ìë¡œ í‘œì‹œ */
        }
        
        .result-value {
            font-weight: bold;
            color: #ffffff;
            font-size: 0.8rem;  /* í°íŠ¸ í¬ê¸° ê°ì†Œ */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-family: 'Courier New', monospace;  /* ê³ ì •í­ í°íŠ¸ */
        }
        
        .result-value.center {
            color: #00ff00;  /* ë” ë°ì€ ë…¹ìƒ‰ */
        }
        
        .result-value.left {
            color: #ff9900;  /* ë” ë°ì€ ì£¼í™©ìƒ‰ */
        }
        
        .result-value.right {
            color: #ff66ff;  /* ë” ë°ì€ í•‘í¬ìƒ‰ */
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ìƒíƒœ í‘œì‹œ */
        .status-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .status-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .status-running {
            color: #38ef7d;
        }

        .status-stopped {
            color: #ff6a00;
        }

        /* íˆìŠ¤í† ê·¸ë¨ */
        .histogram {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .histogram-bar {
            flex: 1;
            margin: 0 10px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            transition: height 0.3s;
            position: relative;
            min-height: 5px;
        }

        .histogram-bar.left {
            background: linear-gradient(to top, #ee0979, #ff6a00);
        }

        .histogram-bar.center {
            background: linear-gradient(to top, #11998e, #38ef7d);
        }

        .histogram-bar.right {
            background: linear-gradient(to top, #667eea, #764ba2);
        }

        .histogram-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }

        .histogram-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }

        /* ë¡œê·¸ */
        .log-box {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff6a00;
        }

        .log-entry.success {
            color: #38ef7d;
        }

        /* í†µê³„ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .status-box {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸš— ììœ¨ì£¼í–‰ ëª¨ë‹ˆí„°ë§</h1>
            <p>ESP32-CAM ê¸°ë°˜ ì°¨ì„  ì¶”ì  ì‹œìŠ¤í…œ (prod.md êµ¬í˜„)</p>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div class="dashboard">
            <!-- ì™¼ìª½: ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ -->
            <div class="card">
                <div class="card-title">ğŸ“¹ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼</div>
            <div class="stream-container">
                <img id="videoStream" src="" alt="ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼">
                <div class="stream-overlay" id="streamOverlay">
                    <div>
                        <p id="streamStatus">ì¹´ë©”ë¼ ì—°ê²° ì¤‘...</p>
                        <button class="btn btn-secondary" onclick="retryStream()" style="margin-top: 15px; display: none;" id="retryButton">
                            ğŸ”„ ì¬ì‹œë„
                        </button>
                    </div>
                </div>
                <!-- ë¶„ì„ ê²°ê³¼ë¥¼ ë¹„ë””ì˜¤ ìœ„ì— ì˜¤ë²„ë ˆì´ -->
                <div id="analysisResult" class="analysis-result" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">DIRECTION:</span>
                        <span class="result-value" id="resultCommand">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">STATE:</span>
                        <span class="result-value" id="resultState">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">CONFIDENCE:</span>
                        <span class="result-value" id="resultConfidence">-</span>
                    </div>
                </div>
            </div>
                
                <!-- íˆìŠ¤í† ê·¸ë¨ -->
                <div style="margin-top: 20px;">
                    <strong>ì°¨ì„  í”½ì…€ ë¶„í¬ (íˆìŠ¤í† ê·¸ë¨)</strong>
                    <div class="histogram">
                        <div style="flex: 1; text-align: center;">
                            <div class="histogram-bar left" id="histLeft" style="height: 0%;">
                                <span class="histogram-value" id="histLeftValue">0</span>
                            </div>
                            <div class="histogram-label">ì™¼ìª½</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div class="histogram-bar center" id="histCenter" style="height: 0%;">
                                <span class="histogram-value" id="histCenterValue">0</span>
                            </div>
                            <div class="histogram-label">ì¤‘ì•™</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div class="histogram-bar right" id="histRight" style="height: 0%;">
                                <span class="histogram-value" id="histRightValue">0</span>
                            </div>
                            <div class="histogram-label">ì˜¤ë¥¸ìª½</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì œì–´ íŒ¨ë„ -->
            <div class="card">
                <div class="card-title">ğŸ® ì œì–´</div>
                <div class="control-panel">
                    <button class="btn btn-start" id="btnStart" onclick="startAutonomous()">
                        â–¶ï¸ ììœ¨ì£¼í–‰ ì‹œì‘
                    </button>
                    <button class="btn btn-stop" id="btnStop" onclick="stopAutonomous()" disabled>
                        â¹ï¸ ììœ¨ì£¼í–‰ ì¤‘ì§€
                    </button>
                    <button class="btn btn-analyze" id="btnAnalyze" onclick="analyzeSingleFrame()">
                        ğŸ” ë‹¨ì¼ í”„ë ˆì„ ë¶„ì„
                    </button>
                    <div id="analysisTimer" class="analysis-timer" style="display: none;">
                        ë¶„ì„ ê²°ê³¼ í‘œì‹œ: <span id="analysisCountdown">5</span>ì´ˆ
                    </div>
                    <div id="analysisResult" class="analysis-result" style="display: none;">
                        <div class="result-item">
                            <span class="result-label">ë°©í–¥ íŒë‹¨:</span>
                            <span class="result-value" id="resultCommand">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ì£¼í–‰ ìƒíƒœ:</span>
                            <span class="result-value" id="resultState">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ì‹ ë¢°ë„:</span>
                            <span class="result-value" id="resultConfidence">-</span>
                        </div>
                    </div>
                </div>

                <!-- ìƒíƒœ í‘œì‹œ -->
                <div class="status-box">
                    <div class="status-item">
                        <div class="status-label">ì‹¤í–‰ ìƒíƒœ</div>
                        <div class="status-value status-stopped" id="statusRunning">ì •ì§€</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">í˜„ì¬ ëª…ë ¹</div>
                        <div class="status-value" id="statusCommand">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ì£¼í–‰ ìƒíƒœ</div>
                        <div class="status-value" id="statusState">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ì‹ ë¢°ë„</div>
                        <div class="status-value" id="statusConfidence">-</div>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div style="margin-top: 30px;">
                    <strong>í†µê³„</strong>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">ì²˜ë¦¬ í”„ë ˆì„</div>
                            <div class="stat-value" id="statFrames">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ëª…ë ¹ ì „ì†¡</div>
                            <div class="stat-value" id="statCommands">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ì˜¤ë¥˜</div>
                            <div class="stat-value" id="statErrors">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ê²½ê³¼ ì‹œê°„</div>
                            <div class="stat-value" id="statTime">0s</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">FPS</div>
                            <div class="stat-value" id="statFPS">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="card">
            <div class="card-title">ğŸ“œ ì‹œìŠ¤í…œ ë¡œê·¸</div>
            <div class="log-box" id="logBox">
                <div class="log-entry">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ...</div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        const ESP32_IP = "{{ esp32_ip }}";
        let statusInterval = null;
        let streamRetryCount = 0;
        const MAX_RETRY = 3;
        const RETRY_INTERVAL = 5000; // 5ì´ˆ

        // ìŠ¤íŠ¸ë¦¼ ìƒíƒœ í‘œì‹œ
        function showStreamStatus(message, showRetry = false) {
            const overlay = document.getElementById('streamOverlay');
            const status = document.getElementById('streamStatus');
            const retryBtn = document.getElementById('retryButton');
            
            status.textContent = message;
            retryBtn.style.display = showRetry ? 'block' : 'none';
            overlay.classList.add('show');
        }

        function hideStreamStatus() {
            const overlay = document.getElementById('streamOverlay');
            overlay.classList.remove('show');
        }

        // ì¹´ë©”ë¼ ì—°ê²° í™•ì¸
        async function checkCamera() {
            try {
                const response = await fetch('/api/autonomous/check_camera');
                const data = await response.json();
                
                if (!data.success) {
                    showStreamStatus(`ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨: ${data.error}`, true);
                    addLog(`âœ— ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨: ${data.error}`, 'error');
                    return false;
                }
                addLog('âœ“ ì¹´ë©”ë¼ ì—°ê²° ì„±ê³µ', 'success');
                return true;
            } catch (e) {
                showStreamStatus(`ì¹´ë©”ë¼ ì²´í¬ ì˜¤ë¥˜: ${e.message}`, true);
                addLog(`âœ— ì¹´ë©”ë¼ ì²´í¬ ì˜¤ë¥˜: ${e.message}`, 'error');
                return false;
            }
        }

        // ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™” (í´ë§ ë°©ì‹)
        let streamInterval = null;
        let streamFrameCount = 0;
        
        async function initStream() {
            showStreamStatus('ì¹´ë©”ë¼ ì—°ê²° í™•ì¸ ì¤‘...');
            addLog('ì¹´ë©”ë¼ ì—°ê²° í™•ì¸ ì¤‘...', 'info');
            
            if (await checkCamera()) {
                addLog('âœ“ ì¹´ë©”ë¼ ì—°ê²° í™•ì¸ ì™„ë£Œ', 'success');
                addLog('ESP32-CAM /capture ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤íŠ¸ë¦¼ ì‹œì‘...', 'info');
                startStreamPolling();
            }
        }
        
        // ìŠ¤íŠ¸ë¦¼ í´ë§ ì‹œì‘ (only when autonomous is not running)
        let autonomousRunning = false;
        
        function startStreamPolling() {
            const videoStream = document.getElementById('videoStream');
            const TARGET_FPS = 5; // 5fpsë¡œ ì œí•œ
            const FRAME_INTERVAL = 1000 / TARGET_FPS; // 200ms
            
            // ê¸°ì¡´ í´ë§ ì¤‘ì§€
            if (streamInterval) {
                clearInterval(streamInterval);
            }
            
            // ì²« í”„ë ˆì„ ë¡œë“œ
            loadFrame();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ í”„ë ˆì„ ë¡œë“œ (only when autonomous is not running)
            streamInterval = setInterval(() => {
                if (!autonomousRunning) {
                    loadFrame();
                }
            }, FRAME_INTERVAL);
            
            function loadFrame() {
                // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì¶”ê°€í•˜ì—¬ ìºì‹œ ë°©ì§€
                const timestamp = new Date().getTime();
                const captureUrl = `http://${ESP32_IP}/capture?t=${timestamp}`;
                
                const img = new Image();
                img.onload = function() {
                    videoStream.src = this.src;
                    streamFrameCount++;
                    
                    // ì²« í”„ë ˆì„ ë¡œë“œ ì‹œ
                    if (streamFrameCount === 1) {
                        hideStreamStatus();
                        addLog('âœ“ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì„±ê³µ (/capture í´ë§ ë°©ì‹)', 'success');
                    }
                    
                    // 10 í”„ë ˆì„ë§ˆë‹¤ ë¡œê·¸
                    if (streamFrameCount % 50 === 0) {
                        addLog(`ìŠ¤íŠ¸ë¦¼ ì •ìƒ ë™ì‘ ì¤‘ (í”„ë ˆì„: ${streamFrameCount})`, 'info');
                    }
                };
                
                img.onerror = function() {
                    if (streamFrameCount === 0) {
                        // ì²« í”„ë ˆì„ ë¡œë“œ ì‹¤íŒ¨
                        handleStreamError();
                    }
                    // ì´í›„ í”„ë ˆì„ì€ ì—ëŸ¬ ë¬´ì‹œ (ë„¤íŠ¸ì›Œí¬ ì¼ì‹œì  ë¬¸ì œ)
                };
                
                img.src = captureUrl;
            }
        }
        
        // ìŠ¤íŠ¸ë¦¼ í´ë§ ì¤‘ì§€
        function stopStreamPolling() {
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
                addLog('ìŠ¤íŠ¸ë¦¼ í´ë§ ì¤‘ì§€', 'info');
            }
        }

        // ìŠ¤íŠ¸ë¦¼ ì—ëŸ¬ ì²˜ë¦¬
        function handleStreamError() {
            showStreamStatus('ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹¤íŒ¨', true);
            addLog('âœ— ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹¤íŒ¨', 'error');
        }

        // ìŠ¤íŠ¸ë¦¼ ì¬ì‹œë„
        function retryStream() {
            if (streamRetryCount >= MAX_RETRY) {
                showStreamStatus('ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.', true);
                addLog('âœ— ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼', 'error');
                return;
            }

            streamRetryCount++;
            streamFrameCount = 0;
            showStreamStatus('ìŠ¤íŠ¸ë¦¼ ì¬ì—°ê²° ì¤‘...');
            addLog('ìŠ¤íŠ¸ë¦¼ ì¬ì—°ê²° ì‹œë„...', 'info');
            
            startStreamPolling();
        }

        // ììœ¨ì£¼í–‰ ì‹œì‘
        async function startAutonomous() {
            try {
                addLog('ììœ¨ì£¼í–‰ ì‹œì‘ ìš”ì²­...', 'info');
                
                const response = await fetch('/api/autonomous/start', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    addLog('âœ“ Autonomous driving started - Commands will be sent to ESP32', 'success');
                    document.getElementById('btnStart').disabled = true;
                    document.getElementById('btnStop').disabled = false;
                    
                    // Mark autonomous as running
                    autonomousRunning = true;
                    
                    // Start status polling
                    startStatusPolling();
                    
                    // Update UI with initial processed image if available
                    if (data.initial_frame && data.initial_frame.processed_image) {
                        document.getElementById('videoStream').src = 'data:image/jpeg;base64,' + data.initial_frame.processed_image;
                        
                        // Update histogram
                        if (data.initial_frame.histogram) {
                            updateHistogram(data.initial_frame.histogram);
                        }
                        
                        // Update status
                        document.getElementById('statusCommand').textContent = data.initial_frame.command || '-';
                        document.getElementById('statusState').textContent = data.initial_frame.state || '-';
                        document.getElementById('statusConfidence').textContent = 
                            data.initial_frame.confidence ? (data.initial_frame.confidence * 100).toFixed(1) + '%' : '-';
                    }
                } else {
                    addLog('âœ— Start failed: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('âœ— ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ììœ¨ì£¼í–‰ ì¤‘ì§€
        async function stopAutonomous() {
            try {
                addLog('ììœ¨ì£¼í–‰ ì¤‘ì§€ ìš”ì²­...', 'info');
                
                const response = await fetch('/api/autonomous/stop', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    addLog('âœ“ Autonomous driving stopped - Commands stopped (stream continues)', 'success');
                    document.getElementById('btnStart').disabled = false;
                    document.getElementById('btnStop').disabled = true;
                    
                    // Mark autonomous as not running
                    autonomousRunning = false;
                    
                    // ìƒíƒœ í´ë§ ì¤‘ì§€
                    stopStatusPolling();
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    if (data.stats) {
                        updateStats(data.stats);
                    }
                } else {
                    addLog('âœ— ì¤‘ì§€ ì‹¤íŒ¨: ' + data.message, 'error');
                }
            } catch (error) {
                addLog('âœ— ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        let analysisTimer = null;  // Timer for analysis display
        let originalStreamSrc = null;  // Store original stream source
        let countdownInterval = null;  // Timer for countdown display
        
        // ë‹¨ì¼ í”„ë ˆì„ ë¶„ì„
        async function analyzeSingleFrame() {
            try {
                // Clear existing timers if any
                if (analysisTimer) {
                    clearTimeout(analysisTimer);
                    analysisTimer = null;
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                // Update button state
                const btnAnalyze = document.getElementById('btnAnalyze');
                btnAnalyze.classList.add('analyzing');
                btnAnalyze.disabled = true;
                
                addLog('ë‹¨ì¼ í”„ë ˆì„ ë¶„ì„ ì¤‘...', 'info');
                
                const response = await fetch('/api/autonomous/analyze', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    addLog(`âœ“ ë¶„ì„ ì™„ë£Œ: ${data.command} (ì‹ ë¢°ë„: ${(data.confidence * 100).toFixed(1)}%)`, 'success');
                    addLog('ë¶„ì„ ê²°ê³¼ë¥¼ 5ì´ˆê°„ í‘œì‹œí•©ë‹ˆë‹¤...', 'info');
                    
                    // Show countdown timer
                    const timerDiv = document.getElementById('analysisTimer');
                    const countdownSpan = document.getElementById('analysisCountdown');
                    timerDiv.style.display = 'block';
                    let countdown = 5;
                    
                    // Show analysis result
                    const resultDiv = document.getElementById('analysisResult');
                    resultDiv.style.display = 'block';
                    resultDiv.style.animation = 'slideIn 0.3s ease-out';
                    
                    // Update result values with animation
                    const resultCommand = document.getElementById('resultCommand');
                    const resultState = document.getElementById('resultState');
                    const resultConfidence = document.getElementById('resultConfidence');
                    
                    resultCommand.textContent = data.command;
                    resultCommand.className = 'result-value ' + data.command.toLowerCase();
                    resultState.textContent = data.state;
                    resultConfidence.textContent = (data.confidence * 100).toFixed(1) + '%';
                    
                    // Update countdown every second
                    countdownInterval = setInterval(() => {
                        countdown--;
                        countdownSpan.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            countdownInterval = null;
                            timerDiv.style.display = 'none';
                            resultDiv.style.display = 'none';
                        }
                    }, 1000);
                    
                    // Store original stream source if not stored
                    const videoStream = document.getElementById('videoStream');
                    if (!originalStreamSrc) {
                        originalStreamSrc = videoStream.src;
                    }
                    
                    // ê²°ê³¼ í‘œì‹œ
                    document.getElementById('statusCommand').textContent = data.command;
                    document.getElementById('statusState').textContent = data.state;
                    document.getElementById('statusConfidence').textContent = (data.confidence * 100).toFixed(1) + '%';
                    
                    // íˆìŠ¤í† ê·¸ë¨ ì—…ë°ì´íŠ¸
                    updateHistogram(data.histogram);
                    
                    // ì´ë¯¸ì§€ í‘œì‹œ ë° ê²°ê³¼ íŒ¨ë„ í‘œì‹œ
                    if (data.image_base64) {
                        // ì´ë¯¸ì§€ í‘œì‹œ
                        videoStream.src = 'data:image/jpeg;base64,' + data.image_base64;
                        
                        // 5ì´ˆ í›„ ëª¨ë“  ê²ƒì„ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
                        analysisTimer = setTimeout(() => {
                            // ì›ë³¸ ìŠ¤íŠ¸ë¦¼ ë³µêµ¬
                            if (originalStreamSrc) {
                                videoStream.src = originalStreamSrc;
                                addLog('ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì¢…ë£Œ', 'info');
                            }
                            analysisTimer = null;
                            
                            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                            const btnAnalyze = document.getElementById('btnAnalyze');
                            btnAnalyze.classList.remove('analyzing');
                            btnAnalyze.disabled = false;
                            
                            // íƒ€ì´ë¨¸ì™€ ê²°ê³¼ íŒ¨ë„ ìˆ¨ê¸°ê¸°
                            document.getElementById('analysisTimer').style.display = 'none';
                            document.getElementById('analysisResult').style.display = 'none';
                            
                            // ì›ë³¸ ìŠ¤íŠ¸ë¦¼ í´ë§ ì¬ì‹œì‘
                            if (!autonomousRunning) {
                                startStreamPolling();
                            }
                        }, 5000);  // 5ì´ˆ í›„ ë³µêµ¬
                        
                        // ìŠ¤íŠ¸ë¦¼ í´ë§ ì¼ì‹œ ì¤‘ì§€ (ë¶„ì„ ì´ë¯¸ì§€ ìœ ì§€ë¥¼ ìœ„í•´)
                        if (streamInterval) {
                            clearInterval(streamInterval);
                        }
                    }
                } else {
                    addLog('âœ— ë¶„ì„ ì‹¤íŒ¨: ' + data.error, 'error');
                }
            } catch (error) {
                addLog('âœ— ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        // Clean up timers when leaving page
        window.addEventListener('beforeunload', () => {
            if (analysisTimer) {
                clearTimeout(analysisTimer);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            // Reset UI state
            const btnAnalyze = document.getElementById('btnAnalyze');
            btnAnalyze.classList.remove('analyzing');
            btnAnalyze.disabled = false;
            document.getElementById('analysisTimer').style.display = 'none';
        });

        // ìƒíƒœ í´ë§ ì‹œì‘
        function startStatusPolling() {
            console.log('ğŸ”„ ìƒíƒœ í´ë§ ì‹œì‘');
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/autonomous/status');
                    const data = await response.json();

                    console.log('ğŸ“Š ìƒíƒœ ì—…ë°ì´íŠ¸:', data);

                    if (data.success) {
                        // Update processed image if available (every 1 second)
                        if (data.latest_image && data.is_running) {
                            const videoStream = document.getElementById('videoStream');
                            videoStream.src = 'data:image/jpeg;base64,' + data.latest_image;
                        }
                        
                        // ìƒíƒœ ì—…ë°ì´íŠ¸
                        document.getElementById('statusRunning').textContent = data.is_running ? 'ì‹¤í–‰ ì¤‘' : 'ì •ì§€';
                        document.getElementById('statusRunning').className = data.is_running ? 'status-value status-running' : 'status-value status-stopped';
                        
                        if (data.last_command) {
                            document.getElementById('statusCommand').textContent = data.last_command;
                            
                            // ëª…ë ¹ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                            const commandEl = document.getElementById('statusCommand');
                            if (data.last_command === 'LEFT') {
                                commandEl.style.color = '#ff6a00';
                            } else if (data.last_command === 'RIGHT') {
                                commandEl.style.color = '#ff00ff';
                            } else if (data.last_command === 'CENTER') {
                                commandEl.style.color = '#38ef7d';
                            } else if (data.last_command === 'STOP') {
                                commandEl.style.color = '#ee0979';
                            }
                        }
                        
                        if (data.state) {
                            const stateText = {
                                'NORMAL_DRIVING': 'ì¼ë°˜ ì£¼í–‰',
                                'CORNER_DETECTED': 'ì½”ë„ˆ ê°ì§€',
                                'TURNING': 'íšŒì „ ì¤‘'
                            }[data.state] || data.state;
                            document.getElementById('statusState').textContent = stateText;
                        }

                        // í†µê³„ ì—…ë°ì´íŠ¸
                        if (data.stats) {
                            updateStats(data.stats);
                        }

                        // ëª…ë ¹ íˆìŠ¤í† ë¦¬ì—ì„œ ìµœê·¼ íˆìŠ¤í† ê·¸ë¨ ê°€ì ¸ì˜¤ê¸°
                        if (data.command_history && data.command_history.length > 0) {
                            const latestCommand = data.command_history[data.command_history.length - 1];
                            if (latestCommand.histogram) {
                                updateHistogram(latestCommand.histogram);
                            }
                        }
                    }
                } catch (error) {
                    console.error('ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
            }, 1000); // 1ì´ˆë§ˆë‹¤
        }

        // ìƒíƒœ í´ë§ ì¤‘ì§€
        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(stats) {
            document.getElementById('statFrames').textContent = stats.frames_processed || 0;
            document.getElementById('statCommands').textContent = stats.commands_sent || 0;
            document.getElementById('statErrors').textContent = stats.errors || 0;
            document.getElementById('statTime').textContent = stats.elapsed_time || '0s';
            document.getElementById('statFPS').textContent = stats.fps || '0';
        }

        // íˆìŠ¤í† ê·¸ë¨ ì—…ë°ì´íŠ¸
        function updateHistogram(histogram) {
            const maxValue = Math.max(histogram.left, histogram.center, histogram.right, 1);
            
            const leftPercent = (histogram.left / maxValue) * 100;
            const centerPercent = (histogram.center / maxValue) * 100;
            const rightPercent = (histogram.right / maxValue) * 100;

            document.getElementById('histLeft').style.height = leftPercent + '%';
            document.getElementById('histCenter').style.height = centerPercent + '%';
            document.getElementById('histRight').style.height = rightPercent + '%';

            document.getElementById('histLeftValue').textContent = histogram.left;
            document.getElementById('histCenterValue').textContent = histogram.center;
            document.getElementById('histRightValue').textContent = histogram.right;
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${timestamp}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;

            // ìµœëŒ€ 100ê°œ ë¡œê·¸ë§Œ ìœ ì§€
            while (logBox.children.length > 100) {
                logBox.removeChild(logBox.firstChild);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            addLog('ììœ¨ì£¼í–‰ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ', 'success');
            addLog(`ESP32-CAM IP: ${ESP32_IP}`, 'info');
            addLog('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼: /capture í´ë§ ë°©ì‹ ì‚¬ìš©', 'info');
            initStream();
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            stopStreamPolling();
            stopStatusPolling();
        });
    </script>
</body>
</html>