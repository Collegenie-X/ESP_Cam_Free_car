# 🔍 세그멘테이션 디버그 가이드

## 문제: 검정색(도로) 인식 안됨

### 증상
- 히스토그램 값이 모두 높음 (L: 6114, C: 6360, R: 6480)
- 검정색(0)이 거의 없고 대부분 장애물(1)로 인식됨
- 도로를 제대로 인식하지 못함

### 원인
**전처리(CLAHE, 밝기 향상)로 인해 검정색 도로가 밝아져서 검정색 범위를 벗어남!**

---

## ✅ 해결 방법

### 1. 검정색 범위 확대 (적용 완료!)

```python
# config.py - 이미 적용됨!
BLACK_V_MAX = 100  # 60 → 100 (더 넓은 범위)
BLACK_S_MAX = 120  # 80 → 120 (더 넓은 범위)
```

**효과:**
- 전처리로 밝아진 도로도 검정색으로 인식
- 히스토그램에서 검정(0) 비율 증가 예상

### 2. 전처리 강도 약화 (적용 완료!)

```python
# config.py - 이미 적용됨!
BRIGHTNESS_BOOST = 15  # 20 → 15
CONTRAST_BOOST = 1.2   # 1.3 → 1.2
```

**효과:**
- 검정색이 덜 밝아짐
- 원래 색상 보존

### 3. 디버그 모드 추가 (새 기능!)

**'D' 키를 누르면** 세그멘테이션 결과를 직접 확인 가능!

```
회색 영역 = 검정(도로) - 0
노란색 영역 = 장애물 - 1
빨간색 영역 = 도로선 - 2
```

화면 상단에 각 색상의 비율도 표시됩니다.

---

## 🎮 디버그 모드 사용법

### 1. 실행

```bash
cd /Users/kimjongphil/Documents/GitHub/ESP_Cam_Free_car/free_car
source venv/bin/activate
python3 autonomous_drive.py
```

### 2. 디버그 모드 활성화

**'D' 키 누르기**

```
🔍 Debug Mode: ON (Segmentation visible)
```

### 3. 화면 확인

**디버그 모드 화면:**
```
Black(road): 12450 (65.2%)   ← 검정 비율 (높을수록 좋음)
Obstacle: 5800 (30.4%)        ← 장애물 비율
Lane: 850 (4.4%)              ← 도로선 비율

[세그멘테이션 컬러 이미지]
회색 = 도로
노란색 = 장애물
빨간색 = 도로선
```

### 4. 트랙바 조정

검정색 비율이 낮으면 (< 50%):

1. **White V Min** 높이기 (77 → 100 → 120)
   - 흰색 차선 임계값 올려서 도로선 감소

2. **White S Max** 낮추기 (65 → 50 → 30)
   - 순수한 흰색만 차선으로 인식

3. Config 수정 (더 극단적인 조정 필요시)
   ```python
   BLACK_V_MAX = 120  # 100 → 120
   ```

### 5. 디버그 모드 해제

**'D' 키 다시 누르기**

```
🔍 Debug Mode: OFF
```

---

## 📊 이상적인 비율

| 환경 | 검정(도로) | 장애물 | 도로선 |
|------|-----------|--------|--------|
| **직선 도로** | 60-80% | 10-30% | 5-10% |
| **곡선 도로** | 50-70% | 20-40% | 5-10% |
| **장애물 많음** | 30-50% | 40-60% | 5-10% |

---

## 🔧 문제별 해결 방법

### 문제 1: 검정색이 너무 적음 (< 30%)

**원인:** 검정색 범위가 너무 좁음

**해결:**
```python
# config.py
BLACK_V_MAX = 120  # 100 → 120
BLACK_S_MAX = 150  # 120 → 150

# 또는 전처리 완전 비활성화
ENABLE_IMAGE_ENHANCEMENT = False
```

### 문제 2: 검정색이 너무 많음 (> 90%)

**원인:** 검정색 범위가 너무 넓어서 도로선까지 검정으로 인식

**해결:**
```python
# config.py
BLACK_V_MAX = 80   # 100 → 80
BLACK_S_MAX = 100  # 120 → 100

# 또는 전처리 강화
BRIGHTNESS_BOOST = 25
CONTRAST_BOOST = 1.4
```

### 문제 3: 도로선이 거의 없음 (< 2%)

**원인:** 도로선 감지 임계값이 너무 높음

**해결:**
- 트랙바 **White V Min** 낮추기 (77 → 60 → 50)
- 트랙바 **White S Max** 높이기 (65 → 80 → 100)

```python
# config.py
GRAY_V_MIN = 40    # 50 → 40 (회색 도로선 포함)
GRAY_V_MAX = 180   # 150 → 180
```

### 문제 4: 장애물이 너무 많음 (> 60%)

**원인:** 실제 장애물이 많거나, 노이즈가 장애물로 인식됨

**해결:**
```python
# config.py
ENABLE_DENOISING = True  # 노이즈 제거 활성화 (느려짐 주의)
```

---

## 💡 실전 팁

### 1. 단계별 조정

```
1. 디버그 모드 ON ('D' 키)
2. 검정색 비율 확인
3. 목표: 50-70%
4. 낮으면: BLACK_V_MAX 증가, White V Min 증가
5. 높으면: BLACK_V_MAX 감소, 전처리 강화
6. 만족하면: 디버그 모드 OFF
```

### 2. 빠른 테스트

**밝은 환경:**
```python
ENABLE_IMAGE_ENHANCEMENT = False  # 전처리 OFF
BLACK_V_MAX = 80
```

**어두운 환경:**
```python
ENABLE_IMAGE_ENHANCEMENT = True
BRIGHTNESS_BOOST = 25
BLACK_V_MAX = 120
```

### 3. 실시간 조정

디버그 모드를 켠 상태에서:
1. 트랙바 조정
2. 세그멘테이션 결과 즉시 확인
3. 검정색 비율이 50-70%가 될 때까지 조정

---

## ⚠️ 주의사항

### ESP32 캡처 속도 문제

화면을 보면:
```
Capture: 2038ms  ← 2초! (너무 느림)
Total: 2227ms
FPS: 1
```

**이것은 Python이 아닌 ESP32 문제입니다!**

**해결 방법:**
1. ESP32 재부팅
2. WiFi 신호 확인
3. 아두이노 코드 재업로드
4. ESP32 설정 확인:
   ```
   해상도: QVGA (320x240)
   JPEG 품질: 10
   프레임 버퍼: 2개
   ```

Python 처리 시간:
```
Process: 188ms  ← 괜찮음!
```

**Python은 빠름, ESP32가 느림!**

---

## 🎯 목표 성능

| 항목 | 목표 | 현재 | 상태 |
|------|------|------|------|
| **FPS** | 5-7 | 1 | ❌ ESP32 문제 |
| **Capture** | < 200ms | 2038ms | ❌ ESP32 문제 |
| **Process** | < 200ms | 188ms | ✅ 양호 |
| **검정 비율** | 50-70% | ? | 🔍 디버그 모드로 확인 |

---

## 📝 체크리스트

실행 전:
- ✅ Config 수정 완료 (BLACK_V_MAX = 100)
- ✅ 전처리 약화 완료 (BRIGHTNESS_BOOST = 15)
- ✅ 디버그 모드 추가 완료

실행 후:
- [ ] 'D' 키로 디버그 모드 ON
- [ ] 검정색 비율 확인
- [ ] 트랙바로 미세 조정
- [ ] 50-70% 도달 시 디버그 모드 OFF
- [ ] ESP32 캡처 속도 확인 (재부팅 필요시)

---

**Made with 🔍 for Better Segmentation**


