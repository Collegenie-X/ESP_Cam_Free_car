# 🔍 실시간 자율주행 분석 도구 가이드

## 📋 개요

`realtime_analysis.py`는 ESP32-CAM의 `/capture` 엔드포인트를 사용하여 **1초당 3프레임**을 분석하고, 실시간으로 차선 인식 결과를 시각화하는 도구입니다.

---

## ✨ 주요 기능

### 1️⃣ 실시간 분석 (3 FPS)
- ESP32-CAM에서 1초당 3장의 사진을 캡처
- 각 프레임마다 차선 인식 및 조향 판단 수행
- **캡처 시간**, **분석 시간**, **전체 시간** 실시간 표시

### 2️⃣ 이중 화면 표시
- **왼쪽**: 원본 이미지
- **오른쪽**: 분석 결과 (차선 마스크, 조향 명령, 히스토그램)

### 3️⃣ 동적 파라미터 조정 (Trackbar)
- **White V Min**: 흰색 차선 밝기 최소값 (0-255)
- **White S Max**: 흰색 차선 채도 최대값 (0-255)
- **Min Pixels**: 최소 차선 픽셀 수 (0-1000)

트랙바를 조정하면 **즉시** 분석 결과에 반영됩니다!

### 4️⃣ 상세 정보 표시
- 조향 명령 (LEFT, RIGHT, CENTER, STOP)
- 히스토그램 (좌/중/우 영역별 픽셀 수)
- 신뢰도 (0-100%)
- 캡처 시간, 분석 시간, 전체 처리 시간
- 현재 FPS

---

## 🚀 사용 방법

### 1. 실행

```bash
cd /Users/kimjongphil/Documents/GitHub/ESP_Cam_Free_car/free_car

# 가상환경 활성화
source venv/bin/activate

# 실행
python realtime_analysis.py
```

또는:

```bash
./realtime_analysis.py
```

### 2. 화면 설명

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│   [원본 이미지]          [분석 결과]                    │
│                                                          │
│   - ESP32-CAM에서       - 차선 마스크 오버레이          │
│     캡처한 원본 사진     - >>> CENTER <<< 조향 명령     │
│                          - 신뢰도: 85.3%                 │
│                          - L:450 C:820 R:320             │
│                          - 캡처: 95ms / 분석: 12ms       │
│                          - FPS: 3                        │
│                                                          │
└──────────────────────────────────────────────────────────┘

[White V Min]  ========●===== (200)
[White S Max]  ======●======= (30)
[Min Pixels]   ========●===== (200)
```

### 3. 트랙바 조정

#### White V Min (흰색 밝기 최소값)
- **낮게 (100-150)**: 어두운 환경에서 차선 검출
- **높게 (200-255)**: 밝은 환경에서 정확한 검출
- **기본값**: 200

#### White S Max (흰색 채도 최대값)
- **낮게 (10-20)**: 순수한 흰색만 검출
- **높게 (30-50)**: 약간 색이 있는 차선도 검출
- **기본값**: 30

#### Min Pixels (최소 픽셀 수)
- **낮게 (100-200)**: 민감하게 반응 (차선이 적어도 인식)
- **높게 (300-500)**: 확실한 차선만 인식
- **기본값**: 200

### 4. 종료

- `q` 키 누르기
- 또는 `Ctrl+C`

---

## 📊 성능 지표

### 예상 성능

| 항목 | 값 |
|------|-----|
| **타겟 FPS** | 3 FPS |
| **평균 캡처 시간** | 80-120ms |
| **평균 분석 시간** | 10-20ms |
| **전체 처리 시간** | 90-140ms |
| **실제 FPS** | 2.8-3.2 FPS |

### 시간 측정

화면 하단에 실시간으로 표시됩니다:
- **캡처**: ESP32에서 이미지를 가져오는 시간
- **분석**: 차선 인식 및 판단 시간
- **전체**: 캡처 + 분석 총 시간

---

## 🎨 조향 명령 색상

- **LEFT** (좌회전): 🟠 주황색
- **RIGHT** (우회전): 🟣 자홍색  
- **CENTER** (직진): 🟢 초록색
- **STOP** (정지): 🔴 빨간색

---

## 🔧 설정 변경

### FPS 변경

`realtime_analysis.py` 파일 상단:

```python
TARGET_FPS = 3  # 원하는 FPS로 변경 (예: 5)
```

**권장값**:
- **1-2 FPS**: 매우 안정적, 느림
- **3 FPS**: 균형 (권장) ⭐
- **4-5 FPS**: 빠름, 불안정할 수 있음

### ESP32 IP 변경

```python
ESP32_IP = "192.168.0.65"  # 실제 ESP32 IP로 변경
```

---

## 🐛 문제 해결

### Q1. "캡처 실패" 메시지가 계속 나옵니다

**A**: ESP32 연결 확인
```bash
# 터미널에서 테스트
curl http://192.168.0.65/status

# 또는 브라우저에서
http://192.168.0.65/capture
```

### Q2. 이미지가 너무 어둡습니다

**A**: 트랙바 조정
- White V Min을 **150-180**으로 낮추기
- 또는 아두이노 센서 밝기 설정 증가

### Q3. 차선이 검출되지 않습니다

**A**: 
1. White V Min을 **150-180**으로 낮추기
2. Min Pixels를 **100-150**으로 낮추기
3. 주변 조명 확인

### Q4. FPS가 3보다 낮습니다

**A**: 
- ESP32와의 네트워크 연결 확인 (WiFi 신호 강도)
- ESP32를 라우터 가까이 이동
- 다른 네트워크 활동 줄이기

### Q5. 화면이 끊깁니다

**A**:
- 정상입니다. 3 FPS는 1초에 3장의 사진이므로 약간 끊길 수 있습니다
- 더 부드럽게 하려면 `TARGET_FPS = 5`로 증가 (단, 불안정할 수 있음)

---

## 💡 활용 팁

### 1. 최적 파라미터 찾기
1. 실시간 분석 도구 실행
2. 트랙바를 조정하며 차선이 잘 검출되는 값 찾기
3. 해당 값을 `config/settings.py`에 반영

### 2. 다양한 환경에서 테스트
- ☀️ 밝은 환경: White V Min 200-220
- 🌙 어두운 환경: White V Min 150-180
- 🌤️ 실내: White V Min 180-200

### 3. 디버깅
- 조향 명령이 이상하면 → 히스토그램 값 확인
- 차선이 안 보이면 → 트랙바 조정
- 속도가 느리면 → 터미널에서 캡처 시간 확인

---

## 📝 기술 세부사항

### 차선 검출 알고리즘

1. **CLAHE** (Contrast Limited Adaptive Histogram Equalization)
   - 이미지 대비 향상
   
2. **가우시안 블러**
   - 노이즈 제거
   
3. **ROI 추출**
   - 하단 25% 영역만 분석 (차선이 있는 영역)
   
4. **HSV 색상 공간 변환**
   - 흰색 및 빨간색 차선 검출
   
5. **모폴로지 연산**
   - 노이즈 제거 (Opening, Closing)
   
6. **히스토그램 분석**
   - 3등분하여 좌/중/우 픽셀 수 계산
   
7. **조향 판단**
   - 데드존 및 편향 비율 기반 판단

### HTTP 연결 최적화

- **세션 재사용**: `requests.Session()` 사용
- **Keep-Alive**: 연결 유지로 오버헤드 감소
- **스트리밍 모드**: 청크 단위 데이터 수신
- **타임아웃**: 2초 (빠른 실패)

---

## 🎯 다음 단계

1. ✅ 실시간 분석으로 최적 파라미터 찾기
2. ✅ `config/settings.py`에 파라미터 반영
3. ✅ `main.py`로 실제 자율주행 실행
4. ✅ 트랙 테스트 및 조정

---

**작성일**: 2025-10-24  
**버전**: v1.0

