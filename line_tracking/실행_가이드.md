# 🚀 라인 트래킹 시스템 - 실행 가이드

## ✅ 준비 사항

### 1. 하드웨어 확인
- ✅ ESP32-CAM이 WiFi에 연결되어 있어야 함
- ✅ 모터가 정상 작동해야 함
- ✅ 컴퓨터와 ESP32-CAM이 같은 네트워크에 있어야 함

### 2. 소프트웨어 확인
```bash
# Python 버전 확인 (3.7 이상)
python3 --version

# 필요한 패키지 설치
pip3 install opencv-python numpy requests
```

---

## 🎯 빠른 시작 (3단계)

### 1단계: IP 주소 확인

시리얼 모니터 또는 라우터 설정에서 ESP32-CAM의 IP 주소를 확인하세요.

예: `192.168.0.65`

### 2단계: 설정 파일 수정

```bash
# config.py 파일 열기
open config.py

# 또는
nano config.py
```

`ESP32_IP` 값을 실제 IP로 변경:

```python
ESP32_IP = "192.168.0.65"  # ← 여기 수정
```

### 3단계: 실행

```bash
# 방법 1: 스크립트 실행
./run_line_tracker.sh

# 방법 2: 직접 실행
python3 main_line_tracker.py
```

---

## 🖥️ 예상 화면

### 터미널 출력

```
============================================================
라인 트래킹 시스템 초기화 시작
============================================================
2025-11-30 10:00:00 - INFO - 라인 검출기 초기화 완료
2025-11-30 10:00:00 - INFO - 방향 판단기 초기화 완료
2025-11-30 10:00:00 - INFO - 시각화 모듈 초기화 완료
2025-11-30 10:00:00 - INFO - ESP32 통신 초기화: http://192.168.0.65
2025-11-30 10:00:00 - INFO - ✅ 시스템 초기화 완료
2025-11-30 10:00:00 - INFO - ESP32-CAM 연결 확인 중...
2025-11-30 10:00:01 - INFO - ✅ ESP32-CAM 연결 성공
============================================================
🚗 라인 트래킹 시작!
============================================================
종료하려면 'q' 키를 누르세요

2025-11-30 10:00:02 - INFO - 프레임: 10 | FPS: 9.8 | 명령: CENTER | 오프셋: 5px
2025-11-30 10:00:03 - INFO - 프레임: 20 | FPS: 9.9 | 명령: LEFT | 오프셋: -45px
...
```

### OpenCV 창

두 개의 화면이 나란히 표시됩니다:

**왼쪽 (원본 + 디버그 정보):**
- 영상에 빨간 수평선 (ROI 경계)
- 파란 수직선 (화면 중심)
- 초록 원 (라인 중심점)
- 명령 텍스트 (LEFT/RIGHT/CENTER)

**오른쪽 (처리된 이미지):**
- Canny Edge Detection 결과
- 흰색 선으로 검출된 엣지 표시

---

## 🛑 종료 방법

### 방법 1: 키보드
- OpenCV 창이 활성화된 상태에서 `q` 키 누르기

### 방법 2: 터미널
- 터미널에서 `Ctrl+C` 누르기

### 종료 시 동작
```
============================================================
시스템 종료 중...
2025-11-30 10:05:00 - INFO - 정지 명령 전송
2025-11-30 10:05:00 - INFO - ✓ 명령 전송: STOP
2025-11-30 10:05:00 - INFO - 총 프레임: 300
2025-11-30 10:05:00 - INFO - 실행 시간: 30.2초
2025-11-30 10:05:00 - INFO - 평균 FPS: 9.9
============================================================
✅ 시스템 종료 완료
============================================================
```

---

## 🔧 테스트 모드

실제 명령을 보내지 않고 화면만 보려면:

```python
# config.py 수정
ENABLE_COMMAND_SEND = False  # True → False로 변경
```

이렇게 하면:
- ✅ 영상 수신 및 라인 검출은 정상 동작
- ✅ 화면에 디버그 정보 표시
- ❌ ESP32에 명령 전송 안 함 (차량이 움직이지 않음)

**테스트 후 다시 활성화:**
```python
ENABLE_COMMAND_SEND = True  # 명령 전송 활성화
```

---

## 🐛 자주 발생하는 문제

### 문제 1: `연결 확인 실패`

```
❌ ESP32-CAM 연결 실패!
URL: http://192.168.0.65/status 확인 필요
```

**해결 방법:**
```bash
# 1. 핑 테스트
ping 192.168.0.65

# 2. 브라우저에서 확인
open http://192.168.0.65/stream

# 3. IP 주소 재확인
# ESP32의 시리얼 모니터에서 IP 확인
```

### 문제 2: `ModuleNotFoundError`

```
ModuleNotFoundError: No module named 'cv2'
```

**해결 방법:**
```bash
pip3 install opencv-python numpy requests
```

### 문제 3: `Line: LOST` 계속 표시

```
화면에 "Line: LOST" 계속 표시됨
```

**해결 방법:**
```python
# config.py에서 민감도 증가
CANNY_LOW_THRESHOLD = 50      # 85 → 50
CANNY_HIGH_THRESHOLD = 100    # 85 → 100
HOUGH_THRESHOLD = 5           # 10 → 5
```

또는 ESP32 밝기 증가:
```bash
curl "http://192.168.0.65/led?state=on"
curl "http://192.168.0.65/camera?param=brightness&value=1"
```

### 문제 4: 화면이 안 나타남

```
프레임은 수신되는데 OpenCV 창이 안 나타남
```

**해결 방법:**
```python
# config.py 확인
SHOW_DEBUG_WINDOW = True  # False → True로 변경
```

### 문제 5: FPS가 너무 낮음 (< 5)

```
평균 FPS: 3.2 (너무 느림)
```

**해결 방법:**
```python
# config.py 최적화
SHOW_PROCESSED_IMAGE = False  # 처리 이미지 표시 끔
LOG_LEVEL = "WARNING"         # 로그 레벨 상승
ROI_BOTTOM_RATIO = 0.6        # ROI 영역 축소
```

---

## 📊 성능 모니터링

### 터미널 로그 해석

```
프레임: 100 | FPS: 9.8 | 명령: LEFT | 오프셋: -45px
```

- **프레임**: 현재까지 처리한 프레임 수
- **FPS**: 초당 프레임 수 (목표: 8-12)
- **명령**: 현재 전송된 명령
- **오프셋**: 중심으로부터의 거리 (픽셀)

### 정상 범위

| 항목 | 정상 범위 | 주의 | 조치 필요 |
|-----|----------|-----|---------|
| **FPS** | 8-12 | 5-8 | < 5 |
| **오프셋** | ±50px | ±50~100px | > ±100px |
| **명령 빈도** | 1-2초당 1회 | 2-5초당 1회 | 초당 5회 이상 |

---

## 🎓 파라미터 튜닝 순서

실제 트랙에서 테스트하면서 다음 순서로 튜닝하세요:

### 1단계: 라인 검출 확인
```python
# 처리 이미지를 보면서 엣지가 잘 검출되는지 확인
SHOW_PROCESSED_IMAGE = True

# 엣지가 너무 적으면 임계값 낮춤
CANNY_LOW_THRESHOLD = 50
CANNY_HIGH_THRESHOLD = 100
```

### 2단계: 중심점 안정화
```python
# 중심점이 떨리면
MIN_LINE_LENGTH = 15      # 최소 라인 길이 증가
MAX_LINE_GAP = 15         # 끊긴 라인 연결
```

### 3단계: 방향 판단 조정
```python
# 너무 민감하면
DEADZONE_THRESHOLD = 40   # 데드존 확대

# 반응이 느리면
DEADZONE_THRESHOLD = 20   # 데드존 축소
```

### 4단계: 성능 최적화
```python
# 안정적이면 성능 개선
SHOW_PROCESSED_IMAGE = False
LOG_LEVEL = "WARNING"
CAPTURE_FPS = 10
```

---

## 📹 디버깅 팁

### 1. 처리 이미지 보기

처리된 이미지(Canny 결과)를 보면 어떤 엣지가 검출되는지 확인 가능:

```python
SHOW_PROCESSED_IMAGE = True
```

**좋은 결과:**
- 라인의 윤곽이 명확하게 흰색으로 표시됨
- 배경 노이즈는 최소화됨

**나쁜 결과:**
- 라인이 거의 안 보임 → 임계값 낮춤
- 배경 노이즈가 너무 많음 → 임계값 높임

### 2. 로그 레벨 조정

```python
# 더 자세한 정보 보기
LOG_LEVEL = "DEBUG"

# 기본 정보만
LOG_LEVEL = "INFO"

# 에러만
LOG_LEVEL = "ERROR"
```

### 3. 단위 테스트 실행

```bash
python3 test_modules.py
```

각 모듈이 정상 작동하는지 확인 가능

---

## 🎯 실전 체크리스트

### 시작 전
- [ ] ESP32-CAM 전원 켜기
- [ ] WiFi 연결 확인
- [ ] IP 주소 확인
- [ ] config.py 수정
- [ ] 라인이 있는 트랙 준비

### 실행 중
- [ ] OpenCV 창이 나타나는가?
- [ ] 영상이 실시간으로 업데이트되는가?
- [ ] 초록 원(중심점)이 표시되는가?
- [ ] 명령이 표시되는가?
- [ ] FPS가 5 이상인가?

### 실제 주행
- [ ] 차량이 명령에 따라 움직이는가?
- [ ] 라인을 따라가는가?
- [ ] 곡선에서도 잘 따라가는가?
- [ ] 명령 전환이 부드러운가?

---

## 🎉 성공 사례

### 예상 동작 시나리오

1. **직선 구간**
   ```
   프레임: 50 | FPS: 9.8 | 명령: CENTER | 오프셋: 3px
   프레임: 60 | FPS: 9.9 | 명령: CENTER | 오프셋: -2px
   프레임: 70 | FPS: 9.8 | 명령: CENTER | 오프셋: 5px
   ```

2. **좌회전 구간**
   ```
   프레임: 80 | FPS: 9.9 | 명령: CENTER | 오프셋: -15px
   프레임: 90 | FPS: 9.8 | 명령: LEFT | 오프셋: -42px
   프레임: 100 | FPS: 9.9 | 명령: LEFT | 오프셋: -55px
   프레임: 110 | FPS: 9.8 | 명령: CENTER | 오프셋: -8px
   ```

3. **우회전 구간**
   ```
   프레임: 120 | FPS: 9.9 | 명령: CENTER | 오프셋: 18px
   프레임: 130 | FPS: 9.8 | 명령: RIGHT | 오프셋: 48px
   프레임: 140 | FPS: 9.9 | 명령: RIGHT | 오프셋: 62px
   프레임: 150 | FPS: 9.8 | 명령: CENTER | 오프셋: 12px
   ```

---

## 📞 도움말

### 추가 문서
- **README.md**: 전체 시스템 설명
- **QUICKSTART.md**: 빠른 시작 가이드
- **LINE_TRACKING_GUIDE.md**: 알고리즘 상세 설명

### 문제 해결
1. 먼저 `test_modules.py` 실행
2. `config.py` 파라미터 확인
3. ESP32 연결 상태 확인
4. 로그 메시지 확인

---

**이제 실행할 준비가 되었습니다! 즐거운 자율주행 되세요!** 🚗💨

